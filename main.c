/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <stdio.h>
#include "stm32f4xx.h"
#include "lcd_stm32f4.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
// TODO: Add values for below variables
#define NS 1024      // Number of samples in LUT
#define TIM2CLK 16000000  // STM Clock frequency: Hint You might want to check the ioc file
#define F_SIGNAL 44100 	// Frequency of output analog signal

#define SINE 0
#define SAWTOOTH 1
#define TRIANGLE 2
#define PIANO 3
#define GUITAR 4
#define DRUM 5

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
TIM_HandleTypeDef htim2;
TIM_HandleTypeDef htim3;
DMA_HandleTypeDef hdma_tim2_ch1;

/* USER CODE BEGIN PV */
// TODO: Add code for global variables, including LUTs
uint32_t Sin_LUT[NS] = {
		2047, 2097, 2147, 2198, 2248, 2298, 2347, 2397,
	    2446, 2496, 2545, 2593, 2641, 2689, 2737, 2784,
	    2831, 2877, 2922, 2968, 3012, 3056, 3100, 3142,
	    3185, 3226, 3267, 3307, 3346, 3384, 3422, 3459,
	    3495, 3530, 3564, 3597, 3630, 3661, 3692, 3721,
	    3749, 3777, 3803, 3829, 3853, 3876, 3898, 3919,
	    3939, 3957, 3975, 3991, 4006, 4020, 4033, 4045,
	    4055, 4064, 4072, 4079, 4085, 4089, 4092, 4094,
	    4095, 4094, 4092, 4089, 4085, 4079, 4072, 4064,
	    4055, 4045, 4033, 4020, 4006, 3991, 3975, 3957,
	    3939, 3919, 3898, 3876, 3853, 3829, 3803, 3777,
	    3749, 3721, 3692, 3661, 3630, 3597, 3564, 3530,
	    3495, 3459, 3422, 3384, 3346, 3307, 3267, 3226,
	    3185, 3142, 3100, 3056, 3012, 2968, 2922, 2877,
	    2831, 2784, 2737, 2689, 2641, 2593, 2545, 2496,
	    2446, 2397, 2347, 2298, 2248, 2198, 2147, 2097,
	    2047, 1997, 1947, 1896, 1846, 1796, 1747, 1697,
	    1648, 1598, 1549, 1501, 1453, 1405, 1357, 1310,
	    1263, 1217, 1172, 1126, 1082, 1038,  994,  952,
	     909,  868,  827,  787,  748,  710,  672,  635,
	     599,  564,  530,  497,  464,  433,  402,  373,
	     345,  317,  291,  265,  241,  218,  196,  175,
	     155,  137,  119,  103,   88,   74,   61,   49,
	      39,   30,   22,   15,    9,    5,    2,    0,
	       0,    0,    2,    5,    9,   15,   22,   30,
	      39,   49,   61,   74,   88,  103,  119,  137,
	     155,  175,  196,  218,  241,  265,  291,  317,
	     345,  373,  402,  433,  464,  497,  530,  564,
	     599,  635,  672,  710,  748,  787,  827,  868,
	     909,  952,  994, 1038, 1082, 1126, 1172, 1217,
	    1263, 1310, 1357, 1405, 1453, 1501, 1549, 1598,
	    1648, 1697, 1747, 1796, 1846, 1896, 1947, 1997
};

uint32_t Saw_LUT[NS] = {
	       0,   16,   32,   48,   64,   80,   96,  112,
	     128,  144,  160,  176,  192,  208,  224,  240,
	     256,  273,  289,  305,  321,  337,  353,  369,
	     385,  401,  417,  433,  449,  465,  481,  497,
	     513,  529,  546,  562,  578,  594,  610,  626,
	     642,  658,  674,  690,  706,  722,  738,  754,
	     770,  786,  802,  819,  835,  851,  867,  883,
	     899,  915,  931,  947,  963,  979,  995, 1011,
	    1027, 1043, 1059, 1075, 1092, 1108, 1124, 1140,
	    1156, 1172, 1188, 1204, 1220, 1236, 1252, 1268,
	    1284, 1300, 1316, 1332, 1348, 1365, 1381, 1397,
	    1413, 1429, 1445, 1461, 1477, 1493, 1509, 1525,
	    1541, 1557, 1573, 1589, 1605, 1621, 1638, 1654,
	    1670, 1686, 1702, 1718, 1734, 1750, 1766, 1782,
	    1798, 1814, 1830, 1846, 1862, 1878, 1894, 1911,
	    1927, 1943, 1959, 1975, 1991, 2007, 2023, 2039,
	    2055, 2071, 2087, 2103, 2119, 2135, 2151, 2167,
	    2184, 2200, 2216, 2232, 2248, 2264, 2280, 2296,
	    2312, 2328, 2344, 2360, 2376, 2392, 2408, 2424,
	    2440, 2457, 2473, 2489, 2505, 2521, 2537, 2553,
	    2569, 2585, 2601, 2617, 2633, 2649, 2665, 2681,
	    2697, 2713, 2730, 2746, 2762, 2778, 2794, 2810,
	    2826, 2842, 2858, 2874, 2890, 2906, 2922, 2938,
	    2954, 2970, 2986, 3003, 3019, 3035, 3051, 3067,
	    3083, 3099, 3115, 3131, 3147, 3163, 3179, 3195,
	    3211, 3227, 3243, 3259, 3276, 3292, 3308, 3324,
	    3340, 3356, 3372, 3388, 3404, 3420, 3436, 3452,
	    3468, 3484, 3500, 3516, 3532, 3549, 3565, 3581,
	    3597, 3613, 3629, 3645, 3661, 3677, 3693, 3709,
	    3725, 3741, 3757, 3773, 3789, 3805, 3822, 3838,
	    3854, 3870, 3886, 3902, 3918, 3934, 3950, 3966,
	    3982, 3998, 4014, 4030, 4046, 4062, 4078, 4095
};

uint32_t Triangle_LUT[NS] = {
	       0,   32,   64,   96,  128,  160,  192,  224,
	     256,  289,  321,  353,  385,  417,  449,  481,
	     513,  546,  578,  610,  642,  674,  706,  738,
	     770,  802,  835,  867,  899,  931,  963,  995,
	    1027, 1059, 1092, 1124, 1156, 1188, 1220, 1252,
	    1284, 1316, 1348, 1381, 1413, 1445, 1477, 1509,
	    1541, 1573, 1605, 1638, 1670, 1702, 1734, 1766,
	    1798, 1830, 1862, 1894, 1927, 1959, 1991, 2023,
	    2055, 2087, 2119, 2151, 2184, 2216, 2248, 2280,
	    2312, 2344, 2376, 2408, 2440, 2473, 2505, 2537,
	    2569, 2601, 2633, 2665, 2697, 2730, 2762, 2794,
	    2826, 2858, 2890, 2922, 2954, 2986, 3019, 3051,
	    3083, 3115, 3147, 3179, 3211, 3243, 3276, 3308,
	    3340, 3372, 3404, 3436, 3468, 3500, 3532, 3565,
	    3597, 3629, 3661, 3693, 3725, 3757, 3789, 3822,
	    3854, 3886, 3918, 3950, 3982, 4014, 4046, 4078,
	    4095, 4062, 4030, 3998, 3966, 3934, 3902, 3870,
	    3838, 3805, 3773, 3741, 3709, 3677, 3645, 3613,
	    3581, 3549, 3516, 3484, 3452, 3420, 3388, 3356,
	    3324, 3292, 3259, 3227, 3195, 3163, 3131, 3099,
	    3067, 3035, 3003, 2970, 2938, 2906, 2874, 2842,
	    2810, 2778, 2746, 2713, 2681, 2649, 2617, 2585,
	    2553, 2521, 2489, 2457, 2424, 2392, 2360, 2328,
	    2296, 2264, 2232, 2200, 2167, 2135, 2103, 2071,
	    2039, 2007, 1975, 1943, 1911, 1878, 1846, 1814,
	    1782, 1750, 1718, 1686, 1654, 1621, 1589, 1557,
	    1525, 1493, 1461, 1429, 1397, 1365, 1332, 1300,
	    1268, 1236, 1204, 1172, 1140, 1108, 1075, 1043,
	    1011,  979,  947,  915,  883,  851,  819,  786,
	     754,  722,  690,  658,  626,  594,  562,  529,
	     497,  465,  433,  401,  369,  337,  305,  273,
	     240,  208,  176,  144,  112,   80,   48,   16
};

uint32_t Piano_LUT[1024] = {
    2047, 2047, 1307, 2109, 1163, 2166, 2915, 1736, 2166, 2459, 1851, 2088, 2075, 1926, 2065, 1825,
    1933, 2255, 2076, 2034, 2133, 2038, 2038, 2069, 2039, 2031, 2040, 2020, 2063, 2076, 2017, 2055,
    2059, 2033, 2040, 2096, 2034, 2016, 2040, 2042, 2078, 2049, 2042, 2060, 2047, 2040, 2048, 2059,
    2033, 2042, 2296, 1440, 2435, 1883, 2323, 1777, 2126, 1821, 2173, 2085, 2034, 2007, 1975, 2105,
    2088, 2018, 2258, 2312, 1982, 2050, 1892, 1685, 1817, 2224, 2240, 2121, 2115, 2074, 2031, 2030,
    2053, 2002, 2136, 1955, 1928, 2282, 1886, 2260, 1860, 2225, 2056, 1545, 2173, 2318, 2511, 1938,
    2304, 1568, 2305, 2560, 2113, 1952, 1738, 2081, 2119, 2272, 2024, 1958, 2139, 2143, 2053, 2022,
    2057, 2011, 1538, 2280, 1732, 1829, 2574, 1798, 2156, 1797, 2189, 1872, 2092, 2166, 2151, 2047,
    1859, 1901, 2294, 2047, 2122, 1991, 1930, 2082, 2036, 2094, 2019, 2061, 2073, 2061, 2077, 1965,
    2072, 2082, 1943, 2136, 2018, 2096, 2048, 2070, 2026, 2026, 2080, 2037, 2055, 2018, 2062, 2067,
    2037, 1985, 2105, 1911, 2091, 2078, 2041, 2051, 2026, 2023, 2064, 2058, 2046, 2040, 2027, 2046,
    2061, 2461, 1620, 2429, 1700, 2322, 1847, 2178, 1975, 2054, 2048, 2055, 2028, 2040, 2057, 2049,
    2046, 1720, 3330, 1654, 2415, 1314, 2032, 2402, 2119, 2004, 1958, 1970, 2004, 2129, 2073, 2084,
    2085, 2816, 1768, 2214, 2098, 2035, 2316, 1533, 2045, 2425, 1810, 2202, 1847, 2019, 2328, 1905,
    2046, 2132, 1778, 2481, 2521, 2024, 1269, 1533, 2545, 2335, 2066, 1934, 2104, 2121, 1834, 2015,
    2121, 2520, 2300, 2413, 1683, 2157, 2048, 2019, 1715, 2277, 2066, 2185, 1948, 2072, 2072, 1880,
    2103, 2926, 1832, 1896, 2434, 1677, 2149, 2122, 1579, 1741, 2290, 2229, 2082, 2124, 2054, 2045,
    1998, 2032, 1966, 2021, 1997, 2045, 2094, 2071, 2063, 2046, 2014, 2062, 2042, 2091, 2038, 2021,
    2036, 2174, 2027, 2033, 2066, 2034, 2089, 2042, 2014, 2068, 2035, 1992, 2085, 2065, 2049, 2043,
    2051, 1688, 2616, 2541, 1582, 2388, 1950, 2109, 1939, 1954, 2108, 1861, 1776, 2159, 2180, 2148,
    2020, 989, 1701, 3017, 1978, 1823, 2416, 1991, 1990, 2196, 1850, 2059, 1994, 1731, 2190, 2216,
    1923, 2334, 1801, 2258, 1819, 2354, 1740, 2274, 1818, 2047, 2192, 1979, 2303, 1640, 2192, 2081,
    1849, 1833, 2149, 2265, 2063, 2097, 1894, 1860, 2059, 2277, 1938, 2059, 2022, 1966, 2105, 2020,
    2135, 1593, 1978, 1426, 2798, 1748, 2126, 2018, 2085, 2060, 2036, 2109, 1959, 2257, 1802, 2072,
    2114, 2055, 1982, 2042, 2000, 2185, 2020, 2034, 2056, 2022, 2062, 2023, 2062, 2064, 2033, 2007,
    2110, 2064, 2118, 1970, 2077, 2017, 2053, 2064, 2051, 2040, 2062, 2027, 2049, 2064, 2050, 2037,
    2042, 2018, 2010, 2145, 1998, 2089, 1985, 2056, 2052, 2053, 2035, 2062, 2053, 2042, 2039, 2049,
    2053, 949, 2600, 1671, 2506, 1695, 2403, 1914, 2020, 1911, 2375, 1913, 2143, 1804, 2053, 2243,
    2029, 1643, 2142, 1909, 2062, 2462, 1910, 1838, 1971, 2037, 2232, 2025, 1983, 2066, 2011, 2061,
    2055, 1726, 2396, 1674, 2305, 1809, 2262, 1986, 2078, 1974, 2028, 2073, 2093, 2021, 2047, 2023,
    730, 2028, 2269, 2332, 2402, 1692, 2148, 1919, 1784, 2168, 1892, 2352, 1978, 1842, 2142, 1968,
    2019, 2084, 2013, 2022, 2039, 1907, 2297, 1881, 2166, 2001, 2022, 2062, 2077, 2051, 2041, 2066,
    1053, 1611, 1509, 1635, 3041, 2299, 1766, 2341, 2048, 1974, 2099, 1980, 2064, 1948, 1710, 2181,
    2218, 1986, 2195, 2075, 1950, 2051, 2044, 2057, 2098, 1936, 2033, 2073, 2062, 2058, 2029, 2045,
    2020, 2052, 2016, 2015, 2047, 2025, 2073, 2071, 2054, 2043, 2077, 2051, 2008, 2058, 2044, 2044,
    1494, 2370, 1280, 2547, 2093, 1863, 2270, 1664, 2216, 2176, 1966, 2069, 1909, 2059, 2166, 2019,
    2077, 2326, 1734, 1783, 2305, 1859, 1598, 2000, 2313, 2214, 2067, 2107, 2086, 2037, 2033, 2066,
    1636, 2357, 1656, 2241, 2003, 2133, 2025, 2032, 2043, 1448, 1716, 1905, 1914, 2238, 2621, 1877,
    1967, 1453, 1706, 2144, 2335, 2541, 1827, 1836, 1904, 1992, 2305, 2025, 2107, 1924, 2016, 2092,
    670, 2701, 2342, 2363, 1440, 2254, 1796, 2346, 1991, 2057, 2045, 2141, 1857, 2089, 2093, 2007,
    2160, 1878, 1977, 2106, 2084, 2057, 2061, 1962, 2052, 2055, 2067, 2062, 2144, 1986, 2037, 1987,
    1938, 2088, 2067, 2115, 2009, 2063, 1996, 2070, 2080, 2031, 2040, 2057, 2021, 2073, 2025, 2052,
    2084, 2054, 2073, 2032, 2041, 2018, 2116, 2034, 2049, 2026, 2039, 2073, 2047, 2028, 2057, 2061,
    1992, 2201, 1864, 2259, 1846, 2223, 1878, 2201, 2041, 2061, 2053, 2023, 2055, 2045, 2047, 2054,
    2408, 950, 2070, 2646, 2080, 1991, 1940, 1771, 2479, 1909, 2034, 1997, 2213, 1898, 2088, 2007,
    2502, 1733, 2377, 1536, 2209, 2306, 1857, 2485, 1523, 2068, 2207, 2172, 2019, 1926, 1980, 2155,
    2570, 1222, 1504, 2193, 2423, 2525, 1824, 1807, 2093, 1938, 2148, 2017, 2130, 2172, 1982, 1999,
    2031, 2051, 1496, 1997, 2433, 1979, 2031, 2154, 2187, 1930, 1739, 2222, 2108, 2103, 2018, 2060,
    2232, 1302, 2661, 2164, 1630, 2518, 1806, 1514, 2158, 2285, 2037, 2024, 2056, 2030, 2071, 2052,
    2125, 2030, 1957, 1989, 2021, 2046, 2076, 2034, 2094, 2054, 2062, 2038, 1998, 2043, 2073, 2069,
    2042, 2060, 2075, 2038, 2016, 2073, 2023, 2074, 2031, 1998, 2053, 2074, 2047, 2044, 2061, 821,
    3043, 2328, 2444, 2029, 2220, 2076, 2002, 2012, 2129, 1724, 1934, 1958, 2224, 2138, 2032, 1507,
    826, 2702, 2646, 1856, 2389, 2211, 1894, 2203, 2036, 1896, 2059, 1749, 1897, 2317, 2082, 2302,
    1816, 2051, 2060, 2066, 2134, 1922, 2209, 1841, 2090, 2547, 2989, 1328, 1916, 1857, 2091, 2638,
    2122, 2079, 1294, 1931, 2353, 2278, 2203, 2046, 2056, 1910, 2106, 2084, 2019, 2008, 1994, 1189,
    3322, 1557, 2501, 1355, 2424, 1914, 2300, 1905, 2098, 2094, 1930, 1995, 2224, 2004, 2155, 1945,
    1990, 2192, 1957, 2116, 1995, 2043, 2097, 2062, 2032, 1915, 2043, 2054, 2068, 2091, 2009, 2129,
    1969, 2031, 2110, 2025, 2061, 1996, 2072, 2010, 2062, 2062, 2051, 2063, 2038, 2027, 2063, 2068,
    2089, 2044, 1984, 2045, 2076, 2048, 2025, 2059, 2015, 2045, 2035, 2064, 2041, 2050, 2031, 3134,
    1641, 2254, 1875, 1921, 2084, 1985, 2407, 1858, 2287, 1604, 2172, 2253, 2054, 2037, 1931, 3005,
    2029, 2178, 1850, 1421, 2491, 2187, 2309, 1941, 1598, 2339, 2050, 2156, 1996, 1882, 2195, 1701,
    2269, 1946, 1934, 2250, 1893, 2227, 1870, 2028, 2133, 2008, 2045, 2044, 2036, 2078, 2062, 2698,
    2392, 2026, 1793, 1578, 2098, 2307, 2437, 2154, 1871, 1823, 2092, 2231, 2116, 2008, 1885, 2340,
    1827, 2410, 1774, 2217, 1817, 2306, 1921, 2255, 1932, 1720, 1879, 2185, 2288, 2190, 1938, 2047
};

uint32_t Guitar_LUT[1024] = {
    2047, 2047, 2047, 2088, 2345, 2068, 1888, 2110, 2207, 1991, 1653, 1731, 2118, 2359, 2464, 2402,
    2154, 1924, 1964, 2083, 2137, 1970, 1780, 1698, 1822, 2116, 2281, 2292, 2170, 1970, 2040, 2168,
    2229, 2115, 1895, 1735, 1716, 1958, 2214, 2539, 2053, 2203, 2116, 2122, 2379, 2020, 2267, 1733,
    1772, 1970, 1893, 2414, 1946, 1757, 2198, 2314, 2903, 2434, 3167, 1894, 1381, 2142, 1069, 2368,
    1119, 2161, 2103, 2182, 2237, 2129, 2017, 2145, 2006, 2081, 2036, 2019, 2046, 1978, 2114, 1997,
    2075, 2052, 2018, 2073, 2036, 2106, 2043, 2041, 2050, 2025, 2028, 2028, 2036, 2050, 2042, 2076,
    2066, 2045, 2056, 2011, 2224, 2369, 1709, 2088, 1881, 2046, 2152, 1863, 2218, 1777, 2180, 2024,
    1922, 2243, 1766, 2145, 2024, 2026, 2073, 2018, 2054, 2043, 2036, 2066, 2027, 2065, 2035, 2056,
    2049, 2029, 2064, 1259, 1929, 2676, 2579, 2139, 1984, 1917, 1590, 1947, 2460, 2404, 2028, 1889,
    1771, 1847, 2184, 2463, 2156, 1909, 1839, 1684, 1932, 2262, 2410, 2059, 1906, 1805, 1853, 2141,
    2426, 2291, 2038, 1898, 1760, 1890, 1987, 2409, 2342, 1875, 1802, 1954, 2315, 2166, 2266, 2266,
    1886, 1780, 2181, 2398, 1710, 2254, 1878, 972, 1388, 2469, 2900, 2186, 1821, 1926, 1935, 2196,
    2348, 1847, 2111, 2222, 1996, 2043, 1984, 2084, 2046, 2044, 2026, 2019, 2061, 2029, 2090, 2046,
    2034, 2023, 2048, 2063, 2066, 2061, 2022, 2017, 2047, 2046, 2068, 2041, 2053, 2049, 2025, 2037,
    2050, 2059, 2071, 2030, 1876, 1978, 1893, 2041, 2089, 2098, 1992, 2127, 2249, 2013, 2071, 2116,
    2015, 1967, 2006, 2130, 1982, 1992, 2074, 2013, 2028, 2046, 2060, 2051, 2040, 2041, 2052, 2045,
    2043, 2053, 2039, 2267, 2182, 1884, 2199, 1778, 2235, 1886, 2032, 2084, 1785, 2300, 1812, 2124,
    2081, 1807, 2298, 1803, 2225, 2009, 1972, 2190, 1807, 2253, 1876, 2109, 2117, 1881, 2254, 1858,
    2166, 2034, 1939, 2298, 1844, 2266, 1749, 1984, 2117, 1875, 2184, 1802, 2055, 2063, 1893, 2109,
    1958, 2190, 1794, 2186, 1588, 2582, 2115, 1342, 2225, 2206, 2387, 2328, 1699, 2202, 2442, 1537,
    2024, 2377, 2188, 2104, 2060, 2104, 2056, 1995, 2019, 2077, 2097, 2018, 2039, 2022, 2049, 2058,
    2018, 2047, 2037, 2049, 2049, 2017, 2072, 2043, 2072, 2046, 2027, 2057, 2049, 2066, 2025, 2037,
    2069, 2038, 2061, 2033, 2065, 2101, 2110, 2179, 2178, 1954, 1893, 1938, 2101, 2196, 2194, 2034,
    1848, 1935, 2075, 2138, 2154, 2139, 1962, 1857, 2018, 2086, 2067, 2042, 2034, 2048, 2059, 2061,
    2048, 2041, 2014, 2583, 1897, 2151, 2164, 1883, 2357, 1849, 2181, 2055, 1932, 2287, 1878, 2263,
    1927, 2048, 2168, 1831, 2318, 1840, 2161, 2104, 1920, 2230, 1862, 2191, 1986, 2013, 2152, 1870,
    2247, 1900, 1915, 1816, 1931, 2018, 1843, 2266, 2102, 2079, 2229, 1716, 2071, 1900, 2054, 2254,
    2065, 2215, 2034, 2364, 2074, 1636, 2150, 1821, 2316, 1530, 2268, 2271, 1652, 1791, 1938, 2139,
    2215, 1982, 2380, 1891, 1719, 1625, 1917, 2326, 2239, 1995, 1827, 1645, 1798, 2140, 2580, 2304,
    2057, 1925, 1895, 2010, 2354, 2458, 2145, 1805, 1665, 1688, 1996, 2343, 2265, 2030, 1878, 1824,
    1933, 2225, 2422, 2080, 2048, 2140, 1929, 1700, 2439, 2496, 1674, 1774, 2061, 1876, 1895, 2595,
    2365, 1672, 1774, 1757, 1530, 1840, 2672, 2394, 1799, 1929, 1981, 1912, 2154, 2344, 2220, 1726,
    1802, 2097, 2247, 1996, 1813, 2081, 1986, 1759, 1580, 2039, 2429, 2519, 2417, 2157, 1917, 1987,
    2045, 2152, 1995, 1765, 1677, 1775, 2116, 2332, 2312, 2177, 1964, 2032, 2141, 2242, 2139, 1898,
    1731, 1696, 1948, 2129, 2171, 1992, 2183, 2121, 2045, 2333, 2018, 2079, 1714, 1717, 1913, 1914,
    2372, 2027, 2220, 1858, 2728, 2636, 2326, 2006, 2132, 1649, 1947, 1987, 2355, 1464, 2244, 2065,
    1716, 2117, 2138, 2040, 2126, 2048, 2056, 1993, 2040, 2039, 2032, 2075, 2016, 2049, 2019, 2049,
    2070, 2034, 2077, 2055, 2032, 2037, 2020, 2054, 2037, 2062, 2048, 2040, 2045, 2047, 2049, 2059,
    2034, 2071, 1924, 2358, 1737, 2216, 2126, 2097, 2320, 1895, 2263, 1895, 2112, 2121, 1875, 2339,
    1827, 2134, 2065, 2024, 2067, 2026, 2055, 2039, 2038, 2069, 2030, 2068, 2041, 2042, 2054, 2027,
    2066, 1434, 1840, 2414, 2737, 2467, 2183, 2059, 1788, 1805, 2261, 2393, 2130, 1846, 1756, 1718,
    1947, 2350, 2359, 2075, 1963, 1835, 1902, 2143, 2347, 2228, 1935, 1838, 1777, 1953, 2248, 2313,
    2126, 1912, 2003, 2060, 2106, 2377, 2203, 2357, 1992, 1786, 2002, 2134, 2195, 2067, 2133, 1973,
    1748, 2061, 2739, 2047, 2770, 1991, 1573, 1988, 2364, 2228, 1643, 2354, 2074, 2162, 1978, 2122,
    2401, 1998, 2015, 1985, 2001, 2027, 2056, 2062, 2063, 1991, 2058, 2078, 2084, 2087, 2013, 2025,
    2007, 2065, 2064, 2039, 2047, 2051, 2043, 2050, 2039, 2036, 2059, 2048, 2055, 2037, 2042, 2051,
    2081, 2022, 1961, 2092, 1723, 1812, 2338, 1893, 2236, 2135, 2232, 1994, 1939, 2290, 1920, 2093,
    2007, 2041, 1960, 1918, 2220, 1980, 2061, 2054, 2055, 2052, 2032, 2044, 2043, 2040, 2048, 2056,
    2049, 2249, 2298, 1813, 2165, 1700, 2254, 2004, 1816, 2300, 1680, 2290, 1983, 1984, 2153, 1773,
    2226, 1844, 2132, 2133, 1825, 2290, 1815, 2187, 2045, 1943, 2184, 1833, 2241, 1903, 2101, 2131,
    1825, 2271, 1993, 2062, 1795, 1963, 2131, 1805, 2179, 1819, 2149, 2000, 1785, 2328, 1901, 2057,
    1914, 2146, 1952, 1581, 2759, 2461, 1102, 2132, 1863, 2240, 1652, 1966, 1969, 2368, 1802, 1611,
    2154, 2127, 1992, 2069, 2010, 2056, 2029, 2018, 2066, 2040, 2050, 2023, 2038, 2063, 2042, 2052,
    2039, 2043, 2067, 2053, 2071, 2026, 2051, 2058, 2035, 2051, 2028, 2065, 2053, 2020, 2061, 2053,
    2044, 2024, 2045, 2094, 2122, 2115, 2177, 2084, 1926, 1948, 2046, 2118, 2210, 2163, 1935, 1837,
    2005, 2134, 2135, 2162, 2083, 1895, 1956, 2066, 2064, 2051, 2032, 2040, 2048, 2065, 2057, 2043,
    2015, 2670, 2195, 1891, 2361, 1913, 2370, 1962, 2182, 1929, 1912, 2308, 1826, 2311, 2016, 1954,
    2256, 1797, 2282, 1897, 2072, 2146, 1822, 2320, 1804, 2223, 2059, 1952, 2204, 1846, 2222, 1948,
    1628, 2030, 1777, 2209, 1976, 2159, 2177, 2055, 1957, 1747, 2200, 1936, 2256, 2256, 1970, 2356,
    1810, 2003, 2247, 1245, 2553, 1932, 1918, 1623, 2437, 1665, 1623, 2202, 2034, 2130, 2083, 2105,
    2442, 1681, 1539, 1661, 1616, 2131, 2530, 2410, 2090, 1942, 1849, 1894, 2301, 2370, 2080, 1834,
    1729, 1748, 2063, 2443, 2396, 2026, 1955, 1819, 1925, 2212, 2429, 2209, 1879, 1763, 1723, 1929,
    2296, 2030, 2189, 2148, 1665, 1839, 2534, 2452, 1936, 2199, 2120, 1490, 1920, 2437, 2184, 1850,
    2219, 2022, 1236, 2369, 2775, 2291, 2130, 2180, 1837, 1725, 2218, 2189, 2169, 2046, 1977, 2045
};

uint32_t Drum_LUT[1024] = {
    2047, 2049, 2048, 969, 593, 466, 4087, 0, 3403, 1007, 2315, 2130, 2328, 2121, 1949, 1911,
    1891, 2254, 1502, 2427, 1674, 2061, 2279, 1809, 2226, 1926, 2011, 2134, 1990, 2078, 2014, 2093,
    2031, 2048, 2027, 4094, 4088, 1730, 3954, 48, 3244, 1610, 2121, 1862, 2690, 1773, 2289, 1836,
    1898, 2463, 1485, 2403, 1809, 1957, 2247, 1890, 2127, 2031, 1951, 2107, 2032, 2060, 2037, 2050,
    2056, 2033, 2044, 54, 4050, 2826, 1972, 1825, 2591, 2344, 1838, 1591, 1930, 2204, 2081, 2012,
    2048, 2114, 2008, 2054, 2026, 2068, 2075, 2035, 2040, 2047, 2037, 2039, 2049, 2040, 2057, 2047,
    2029, 2054, 2385, 3578, 1723, 4080, 0, 2998, 1158, 2398, 2123, 2991, 1882, 2168, 1665, 1832,
    2384, 1629, 2024, 2100, 1735, 2170, 2098, 1949, 2191, 1963, 2088, 2060, 1981, 2100, 1964, 2091,
    2006, 2075, 2266, 2046, 2116, 2090, 1756, 2071, 1983, 2043, 2092, 2075, 2020, 2063, 2018, 2049,
    2038, 2032, 2059, 2037, 2024, 2048, 2086, 2045, 2054, 2061, 2032, 2061, 2060, 2040, 2050, 2051,
    2045, 2052, 1907, 2734, 2006, 2106, 2288, 2063, 2027, 2005, 2002, 1983, 2007, 2055, 2060, 2042,
    2049, 2062, 2087, 2028, 2083, 2026, 2041, 2026, 2012, 2042, 2034, 2031, 2054, 2049, 2044, 2047,
    2045, 2046, 484, 136, 3561, 3473, 1877, 1816, 2370, 2459, 1953, 1789, 1893, 2130, 2151, 2015,
    1992, 2055, 2048, 2011, 2019, 2077, 2050, 2046, 2057, 2027, 2042, 2050, 2060, 2041, 2035, 2043,
    2058, 2028, 1666, 1930, 2115, 1984, 1919, 2022, 1917, 1955, 2032, 2019, 2066, 2039, 2045, 2054,
    2037, 2053, 223, 1583, 3680, 122, 3013, 1018, 1869, 2590, 1138, 3272, 1372, 1989, 2095, 2239,
    1759, 2456, 3618, 4081, 1736, 3593, 654, 3202, 1817, 2157, 1669, 2778, 1663, 2450, 1862, 1907,
    2484, 1568, 2358, 1936, 1923, 2230, 1936, 2101, 2073, 1945, 2097, 2055, 2049, 2047, 2028, 2069,
    2028, 1791, 2339, 2057, 2171, 2135, 1990, 2057, 2105, 2092, 2052, 2036, 2056, 2013, 2055, 2052,
    2042, 2042, 2070, 2046, 2033, 2042, 2097, 2063, 2090, 2025, 2062, 2044, 2045, 2049, 2047, 2054,
    2059, 1364, 1343, 1097, 3061, 2274, 1891, 1791, 1842, 2274, 2216, 2063, 1818, 2002, 2107, 2042,
    2015, 2007, 2088, 2001, 2025, 2050, 2041, 2028, 2058, 2048, 2038, 2059, 2049, 2048, 2050, 2056,
    2063, 635, 3709, 1248, 2767, 1934, 3404, 1894, 2493, 1326, 2737, 1421, 2692, 1846, 1821, 2093,
    2121, 1869, 2131, 2023, 1889, 2242, 1921, 2138, 2029, 1995, 2172, 2076, 2055, 1996, 2130, 2049,
    2033, 1623, 1810, 2063, 2318, 2246, 1910, 2050, 1943, 2031, 2025, 2029, 2075, 2052, 2042, 2046,
    2167, 1957, 2036, 2085, 2067, 2056, 2043, 2038, 2042, 2044, 2048, 2049, 2047, 2044, 2044, 2049,
    2042, 1549, 99, 394, 4091, 0, 3405, 917, 2295, 2148, 2283, 2180, 1926, 1921, 1897, 2220,
    1565, 2450, 1678, 2074, 2286, 1812, 2236, 1916, 2015, 2134, 1986, 2078, 2011, 2099, 2029, 2046,
    2059, 4094, 3609, 1550, 1867, 2380, 2311, 1182, 1584, 2367, 2355, 2092, 1930, 1971, 2117, 2094,
    2018, 2041, 2064, 2022, 2016, 2028, 2050, 2082, 2059, 2030, 2043, 2049, 2057, 2026, 2055, 2045,
    2073, 1877, 1589, 2074, 2009, 1899, 1980, 2043, 2106, 2054, 2055, 2046, 2046, 2038, 2042, 2043,
    2775, 3956, 401, 4094, 0, 3975, 1255, 2025, 2394, 1462, 2623, 2031, 1971, 1892, 2453, 1657,
    2390, 9, 572, 1904, 2310, 2565, 3361, 2341, 2408, 1024, 2501, 1348, 2666, 1952, 1890, 2388,
    1862, 2246, 2181, 1868, 2076, 2107, 1980, 2168, 1986, 2027, 2117, 2013, 2092, 1975, 2092, 2039,
    2249, 3641, 1303, 2021, 2323, 2636, 2150, 2118, 2266, 1382, 2378, 1340, 2442, 2090, 1980, 2240,
    2129, 1948, 2243, 1938, 1929, 2206, 1916, 2174, 2054, 1979, 2111, 1990, 2113, 1972, 2087, 2063,
    2712, 4025, 2705, 1490, 1503, 2546, 1834, 1929, 1675, 1925, 2148, 2126, 2009, 1997, 2072, 2058,
    2063, 2050, 2032, 2095, 2077, 2029, 2035, 2057, 2044, 2035, 2042, 2045, 2053, 2036, 2049, 2036,
    1391, 521, 1899, 2320, 2870, 2764, 2555, 2286, 1432, 2123, 1376, 2627, 2109, 2396, 1917, 2463,
    1928, 2056, 2224, 1745, 2297, 1979, 1944, 2128, 1901, 2109, 2046, 2098, 2027, 2063, 2035, 2113,
    2930, 1568, 1445, 1697, 2014, 2049, 2045, 2034, 2054, 2077, 2018, 2029, 2060, 2037, 2037, 2048,
    1957, 2032, 2019, 2036, 2055, 2036, 2050, 2050, 2045, 2049, 2039, 2041, 2046, 2045, 2054, 2043,
    2632, 1999, 1971, 1886, 2162, 2057, 2150, 2045, 2005, 2014, 2044, 2003, 2043, 2053, 2032, 2057,
    2073, 2035, 2041, 2045, 2040, 2014, 2027, 2025, 2063, 2055, 2047, 2048, 2046, 2046, 2045, 1763,
    7, 2707, 2109, 1628, 2440, 2320, 2634, 2137, 1761, 1827, 2092, 2133, 2063, 1996, 2056, 2059,
    2041, 2020, 2028, 2045, 2063, 2048, 2038, 2044, 2055, 2067, 2021, 2079, 2033, 2085, 2045, 2508,
    1695, 1696, 2244, 2172, 1999, 2204, 2066, 2027, 2013, 2035, 2052, 2045, 2053, 2039, 2050, 1030,
    2694, 1645, 2891, 635, 3822, 1883, 2372, 1736, 2189, 1881, 2430, 2022, 1802, 2313, 1895, 2236,
    3670, 2488, 2305, 2181, 2527, 1417, 1879, 2207, 1621, 2459, 1439, 2323, 2124, 2010, 2104, 2205,
    1847, 2239, 1993, 1888, 2235, 1887, 2163, 2083, 1963, 2099, 1987, 2123, 1975, 2075, 2065, 1533,
    2137, 1941, 2163, 2131, 2009, 2076, 1989, 2020, 2057, 2000, 2062, 2060, 2010, 2063, 2038, 2063,
    2053, 2017, 2100, 1989, 2011, 2066, 2025, 2047, 2042, 2054, 2045, 2048, 2045, 2048, 2051, 2577,
    4, 1854, 2303, 2090, 1603, 2131, 2560, 2369, 1971, 2026, 2059, 2099, 2037, 2008, 2017, 2073,
    2063, 2021, 2056, 2068, 2056, 2041, 2062, 2044, 2056, 2050, 2049, 2054, 2045, 2035, 1888, 3931,
    1914, 3222, 409, 2809, 321, 1879, 2044, 2014, 2374, 1834, 2318, 1932, 2468, 1585, 2429, 2010,
    1852, 2475, 1787, 2020, 2070, 1863, 2171, 1950, 2023, 2035, 2118, 2034, 1992, 2090, 2167, 1586,
    1952, 1931, 2242, 2156, 2077, 1987, 2055, 2012, 2021, 2040, 2036, 2075, 2039, 2029, 2091, 2017,
    2068, 2061, 2060, 2043, 2043, 2067, 2025, 2046, 2054, 2046, 2052, 2051, 2041, 2053, 2043, 8,
    672, 2074, 2431, 2385, 3349, 2312, 2393, 1034, 2532, 1377, 2684, 1940, 1892, 2451, 1848, 2285,
    2163, 1863, 2087, 2087, 1992, 2159, 1982, 2035, 2115, 2009, 2084, 1980, 2092, 2035, 4086, 4000,
    1026, 1894, 1816, 2419, 1651, 1700, 2108, 2365, 2193, 1889, 1949, 2104, 2101, 2006, 2054, 2083,
    2015, 1973, 2045, 2040, 2058, 2051, 2043, 2044, 2065, 2028, 2055, 2034, 2069, 2036, 2292, 2240,
    2149, 1832, 2081, 2083, 1969, 2051, 2010, 2085, 2048, 2070, 2049, 2050, 2041, 1973, 3038, 643,
    1933, 2946, 1283, 3016, 1617, 2759, 1266, 2676, 1214, 2415, 2120, 1871, 2052, 2140, 2047, 2047
};



// Track current waveform
uint32_t currentLUT = SINE;

uint32_t buttonLastPressed = 0;


// TODO: Equation to calculate TIM2_Ticks
uint32_t TIM2_Ticks = TIM2CLK/(NS*F_SIGNAL); // How often to write new LUT value
uint32_t DestAddress = (uint32_t) &(TIM3->CCR3); // Write LUT TO TIM3->CCR3 to modify PWM duty cycle


/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_TIM2_Init(void);
static void MX_TIM3_Init(void);
/* USER CODE BEGIN PFP */
void EXTI0_IRQHandler(void);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_TIM2_Init();
  MX_TIM3_Init();
  /* USER CODE BEGIN 2 */

  // TODO: Initialize LCD
  init_LCD();
  lcd_command(DISPLAY_ON);
  lcd_command(CLEAR);
  lcd_command(CURSOR_HOME);

  // TODO: Start TIM3 in PWM mode on channel 3
  HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_3);

  // TODO: Start TIM2 in Output Compare (OC) mode on channel 1
  HAL_TIM_OC_Start(&htim2, TIM_CHANNEL_1);

  // TODO: Start DMA in IT mode on TIM2->CH1. Source is LUT and Dest is TIM3->CCR3; start with Sine LUT
  HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Piano_LUT, DestAddress, NS);

  // TODO: Write current waveform to LCD(Sine is the first waveform)
  lcd_putstring("SINE");

  // TODO: Enable DMA (start transfer from LUT to CCR)
  __HAL_TIM_ENABLE_DMA(&htim2, TIM_DMA_CC1);

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */
	  //lcd_putstring("HELLO!");
    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE3);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_NONE;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_HSI;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_0) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};
  TIM_OC_InitTypeDef sConfigOC = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 0;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = TIM2_Ticks - 1;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_TIM_OC_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sConfigOC.OCMode = TIM_OCMODE_TIMING;
  sConfigOC.Pulse = 0;
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  if (HAL_TIM_OC_ConfigChannel(&htim2, &sConfigOC, TIM_CHANNEL_1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */
  /* TIM2_CH1 DMA Init */
  __HAL_RCC_DMA1_CLK_ENABLE();

  hdma_tim2_ch1.Instance = DMA1_Stream5;
  hdma_tim2_ch1.Init.Channel = DMA_CHANNEL_3;         // TIM2_CH1 is on channel 3
  hdma_tim2_ch1.Init.Direction = DMA_MEMORY_TO_PERIPH; // Memory -> TIM3->CCR3
  hdma_tim2_ch1.Init.PeriphInc = DMA_PINC_DISABLE;    // Peripheral address fixed
  hdma_tim2_ch1.Init.MemInc = DMA_MINC_ENABLE;        // Memory address increments
  hdma_tim2_ch1.Init.PeriphDataAlignment = DMA_PDATAALIGN_WORD;
  hdma_tim2_ch1.Init.MemDataAlignment = DMA_MDATAALIGN_WORD;
  hdma_tim2_ch1.Init.Mode = DMA_CIRCULAR;            // Repeat LUT automatically
  hdma_tim2_ch1.Init.Priority = DMA_PRIORITY_HIGH;
  hdma_tim2_ch1.Init.FIFOMode = DMA_FIFOMODE_DISABLE;

  if (HAL_DMA_Init(&hdma_tim2_ch1) != HAL_OK)
  {
      Error_Handler();
  }

  /* Link DMA handle to TIM2 handle */
  __HAL_LINKDMA(&htim2, hdma[TIM_DMA_ID_CC1], hdma_tim2_ch1);
  /* USER CODE END TIM2_Init 2 */

}

/**
  * @brief TIM3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM3_Init(void)
{

  /* USER CODE BEGIN TIM3_Init 0 */

  /* USER CODE END TIM3_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};
  TIM_OC_InitTypeDef sConfigOC = {0};

  /* USER CODE BEGIN TIM3_Init 1 */

  /* USER CODE END TIM3_Init 1 */
  htim3.Instance = TIM3;
  htim3.Init.Prescaler = 0;
  htim3.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim3.Init.Period = 4095;
  htim3.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim3.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim3) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim3, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_TIM_PWM_Init(&htim3) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim3, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sConfigOC.OCMode = TIM_OCMODE_PWM1;
  sConfigOC.Pulse = 0;
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  if (HAL_TIM_PWM_ConfigChannel(&htim3, &sConfigOC, TIM_CHANNEL_3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM3_Init 2 */

  /* USER CODE END TIM3_Init 2 */
  HAL_TIM_MspPostInit(&htim3);

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Stream5_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Stream5_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Stream5_IRQn);

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  /* USER CODE BEGIN MX_GPIO_Init_1 */

  /* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();

  // -------------------------------
  // LCD pins configuration
  // -------------------------------
  // Configure PC14 (RS) and PC15 (E) as output push-pull
  GPIO_InitStruct.Pin = GPIO_PIN_14 | GPIO_PIN_15;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  // Configure PB8 (D4) and PB9 (D5) as output push-pull
  GPIO_InitStruct.Pin = GPIO_PIN_8 | GPIO_PIN_9;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

  // Configure PA12 (D6) and PA15 (D7) as output push-pull
  GPIO_InitStruct.Pin = GPIO_PIN_12 | GPIO_PIN_15;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  // Set all LCD pins LOW initially
  HAL_GPIO_WritePin(GPIOC, GPIO_PIN_14 | GPIO_PIN_15, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(GPIOB, GPIO_PIN_8 | GPIO_PIN_9, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_12 | GPIO_PIN_15, GPIO_PIN_RESET);


  // -------------------------------
  // Button0 configuration (PA0)
  // -------------------------------
  GPIO_InitStruct.Pin = Button0_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING; // Interrupt on rising edge
  GPIO_InitStruct.Pull = GPIO_PULLUP;         // Use pull-up resistor
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  // Enable and set EXTI line 0 interrupt priority
  HAL_NVIC_SetPriority(EXTI0_IRQn, 2, 0);
  HAL_NVIC_EnableIRQ(EXTI0_IRQn);

  /* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */
void EXTI0_IRQHandler(void){

	HAL_GPIO_EXTI_IRQHandler(Button0_Pin); // Clear interrupt flags

	// TODO: Debounce using HAL_GetTick()
	if (HAL_GetTick() - buttonLastPressed > 200){
		buttonLastPressed = HAL_GetTick();

		// TODO: Disable DMA transfer and abort IT, then start DMA in IT mode with new LUT and re-enable transfer
		// HINT: Consider using C's "switch" function to handle LUT changes
		__HAL_TIM_DISABLE_DMA(&htim2, TIM_DMA_CC1);
		HAL_DMA_Abort_IT(&hdma_tim2_ch1);

		currentLUT = (currentLUT + 1) % 6;

		switch(currentLUT){
			case SINE:
				lcd_command(CLEAR); lcd_putstring("SINE");
				HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Sin_LUT, DestAddress, NS);
				break;
			case SAWTOOTH:
				lcd_command(CLEAR); lcd_putstring("SAWTOOTH");
				HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Saw_LUT, DestAddress, NS);
				break;
			case TRIANGLE:
				lcd_command(CLEAR); lcd_putstring("TRIANGLE");
				HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Triangle_LUT, DestAddress, NS);
				break;
			case PIANO:
				lcd_command(CLEAR); lcd_putstring("PIANO");
				HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Piano_LUT, DestAddress, NS);
				break;
			case GUITAR:
				lcd_command(CLEAR); lcd_putstring("GUITAR");
				HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Guitar_LUT, DestAddress, NS);
				break;
			case DRUM:
				lcd_command(CLEAR); lcd_putstring("DRUM");
				HAL_DMA_Start_IT(&hdma_tim2_ch1, (uint32_t)Drum_LUT, DestAddress, NS);
				break;
		}

		__HAL_TIM_ENABLE_DMA(&htim2, TIM_DMA_CC1);

	}

}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}
#ifdef USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
